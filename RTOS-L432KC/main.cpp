#include "mbed.h"
#include "rtos.h"
#include "DHT11.h"
#include "LPS25HB.h"
#include "logo.h"

// ================== I2C + DEVICES ==================
I2C i2c(I2C_SDA, I2C_SCL);
#define SSD1306_ADDR 0x78

DHT11 d(PA_11);
LPS25HB ps(i2c);

// ================== RTOS ==================
struct SensorData {
    float lps_temp;
    float pressure;
    int   dht_temp;
    int   humidity;
    bool  dht_ok;
};

Thread sensors_thread(osPriorityNormal, 4096);
Thread display_thread(osPriorityLow,    4096);

Mutex i2c_mutex;
Queue<SensorData, 4> sensor_queue;
EventFlags flags;

#define FLAG_NEW_DATA 0x01

// ================== OLED LOW LEVEL ==================
void oled_cmd(uint8_t cmd) {
    char d[2] = {0x00, cmd};
    i2c.write(SSD1306_ADDR, d, 2);
}

void oled_data(uint8_t data) {
    char d[2] = {0x40, data};
    i2c.write(SSD1306_ADDR, d, 2);
}

void oled_init() {
    oled_cmd(0xAE);
    oled_cmd(0xD5); oled_cmd(0x80);
    oled_cmd(0xA8); oled_cmd(0x3F);
    oled_cmd(0xD3); oled_cmd(0x00);
    oled_cmd(0x40);
    oled_cmd(0x8D); oled_cmd(0x14);
    oled_cmd(0x20); oled_cmd(0x00);
    oled_cmd(0xA1); oled_cmd(0xC8);
    oled_cmd(0xDA); oled_cmd(0x12);
    oled_cmd(0x81); oled_cmd(0xCF);
    oled_cmd(0xD9); oled_cmd(0xF1);
    oled_cmd(0xDB); oled_cmd(0x40);
    oled_cmd(0xA4);
    oled_cmd(0xA6);
    oled_cmd(0xAF);
}

void oled_set_pos(int page, int col) {
    oled_cmd(0x21); oled_cmd(col); oled_cmd(127);
    oled_cmd(0x22); oled_cmd(page); oled_cmd(7);
}

void oled_clear() {
    oled_set_pos(0,0);
    for(int i=0;i<1024;i++) oled_data(0x00);
}
struct Glyph { char ch; uint8_t d[5]; };

const Glyph font[] = {
    {' ', {0x00,0x00,0x00,0x00,0x00}},

    // --- digits ---
    {'0', {0x3E,0x51,0x49,0x45,0x3E}},
    {'1', {0x00,0x42,0x7F,0x40,0x00}},
    {'2', {0x42,0x61,0x51,0x49,0x46}},
    {'3', {0x21,0x41,0x45,0x4B,0x31}},
    {'4', {0x18,0x14,0x12,0x7F,0x10}},
    {'5', {0x27,0x45,0x45,0x45,0x39}},
    {'6', {0x3C,0x4A,0x49,0x49,0x30}},
    {'7', {0x01,0x71,0x09,0x05,0x03}},
    {'8', {0x36,0x49,0x49,0x49,0x36}},
    {'9', {0x06,0x49,0x49,0x29,0x1E}},

    // --- lowercase alphabet ---
    {'a', {0x20,0x54,0x54,0x54,0x78}},
    {'b', {0x7F,0x48,0x44,0x44,0x38}},
    {'c', {0x38,0x44,0x44,0x44,0x20}},
    {'d', {0x38,0x44,0x44,0x48,0x7F}},
    {'e', {0x38,0x54,0x54,0x54,0x18}},
    {'f', {0x08,0x7E,0x09,0x01,0x02}},
    {'g', {0x0C,0x52,0x52,0x52,0x3E}},
    {'h', {0x7F,0x08,0x04,0x04,0x78}},
    {'i', {0x00,0x44,0x7D,0x40,0x00}},
    {'j', {0x20,0x40,0x44,0x3D,0x00}},
    {'k', {0x7F,0x10,0x28,0x44,0x00}},
    {'l', {0x00,0x41,0x7F,0x40,0x00}},
    {'m', {0x7C,0x04,0x18,0x04,0x78}},
    {'n', {0x7C,0x08,0x04,0x04,0x78}},
    {'o', {0x38,0x44,0x44,0x44,0x38}},
    {'p', {0x7C,0x14,0x14,0x14,0x08}},
    {'q', {0x08,0x14,0x14,0x18,0x7C}},
    {'r', {0x7C,0x08,0x04,0x04,0x08}},
    {'s', {0x48,0x54,0x54,0x54,0x20}},
    {'t', {0x04,0x3F,0x44,0x40,0x20}},
    {'u', {0x3C,0x40,0x40,0x20,0x7C}},
    {'v', {0x1C,0x20,0x40,0x20,0x1C}},
    {'w', {0x3C,0x40,0x30,0x40,0x3C}},
    {'x', {0x44,0x28,0x10,0x28,0x44}},
    {'y', {0x0C,0x50,0x50,0x50,0x3C}},
    {'z', {0x44,0x64,0x54,0x4C,0x44}},


    // --- uppercase alphabet ---
    {'A', {0x7E,0x11,0x11,0x11,0x7E}},
    {'B', {0x7F,0x49,0x49,0x49,0x36}},
    {'C', {0x3E,0x41,0x41,0x41,0x22}},
    {'D', {0x7F,0x41,0x41,0x22,0x1C}},
    {'E', {0x7F,0x49,0x49,0x49,0x41}},
    {'F', {0x7F,0x09,0x09,0x09,0x01}},
    {'G', {0x3E,0x41,0x49,0x49,0x7A}},
    {'H', {0x7F,0x08,0x08,0x08,0x7F}},
    {'I', {0x00,0x41,0x7F,0x41,0x00}},
    {'J', {0x20,0x40,0x41,0x3F,0x01}},
    {'K', {0x7F,0x08,0x14,0x22,0x41}},
    {'L', {0x7F,0x40,0x40,0x40,0x40}},
    {'M', {0x7F,0x02,0x04,0x02,0x7F}},
    {'N', {0x7F,0x04,0x08,0x10,0x7F}},
    {'O', {0x3E,0x41,0x41,0x41,0x3E}},
    {'P', {0x7F,0x09,0x09,0x09,0x06}},
    {'Q', {0x3E,0x41,0x51,0x21,0x5E}},
    {'R', {0x7F,0x09,0x19,0x29,0x46}},
    {'S', {0x46,0x49,0x49,0x49,0x31}},
    {'T', {0x01,0x01,0x7F,0x01,0x01}},
    {'U', {0x3F,0x40,0x40,0x40,0x3F}},
    {'V', {0x1F,0x20,0x40,0x20,0x1F}},
    {'W', {0x7F,0x20,0x18,0x20,0x7F}},
    {'X', {0x63,0x14,0x08,0x14,0x63}},
    {'Y', {0x03,0x04,0x78,0x04,0x03}},
    {'Z', {0x61,0x51,0x49,0x45,0x43}},

    // --- symbols ---
    {':', {0x00,0x36,0x36,0x00,0x00}},
    {'%', {0x62,0x64,0x08,0x13,0x23}},
    {'-', {0x08,0x08,0x08,0x08,0x08}},
    {'.', {0x00,0x60,0x60,0x00,0x00}},
};

const uint8_t* glyph(char c){
    for(auto &g:font) if(g.ch==c) return g.d;
    return font[0].d;
}

void print_char(char c){
    const uint8_t *g = glyph(c);
    for(int i=0;i<5;i++) oled_data(g[i]);
    oled_data(0x00);
}

void print_string(const char *s){
    while(*s) print_char(*s++);
}

void clear_area(int page,int col,int chars){
    oled_set_pos(page,col);
    for(int i=0;i<chars*6;i++) oled_data(0x00);
}

void print_string_at_clear(int page,int col,int chars,const char *s){
    clear_area(page,col,chars);
    oled_set_pos(page,col);
    print_string(s);
}

// ================== STATIC LAYOUT ==================
void draw_layout(){
    oled_set_pos(0,0);  print_string("Temp LPS:");
    oled_set_pos(0,64); print_string("Temp DHT:");
    oled_set_pos(4,0);  print_string("Pressure:");
    oled_set_pos(4,64); print_string("Humidity:");
}

// ================== THREADS ==================
void sensors_task(){
    static SensorData dta;
    while(true){
        i2c_mutex.lock();
        dta.lps_temp = ps.readTemperatureC();
        dta.pressure = ps.readPressureMillibars();
        i2c_mutex.unlock();

        if(d.readData()==DHT11::OK){
            dta.dht_temp = d.readTemperature();
            dta.humidity = d.readHumidity();
            dta.dht_ok   = true;
        } else {
            dta.dht_ok = false;
        }

        sensor_queue.put(&dta);
        flags.set(FLAG_NEW_DATA);
        ThisThread::sleep_for(5s);
    }
}

void display_task(){
    SensorData *rx;
    char buf[16];

    while(true){
        flags.wait_any(FLAG_NEW_DATA);

        while(sensor_queue.try_get(&rx)){
            i2c_mutex.lock();

            snprintf(buf,16,"%.1f C",rx->lps_temp);
            print_string_at_clear(2,0,10,buf);

            snprintf(buf,16,"%.0f hPa",rx->pressure);
            print_string_at_clear(6,0,10,buf);

            if(rx->dht_ok){
                snprintf(buf,16,"%d C",rx->dht_temp);
                print_string_at_clear(2,64,8,buf);
                snprintf(buf,16,"%d %%",rx->humidity);
                print_string_at_clear(6,64,8,buf);
            } else {
                print_string_at_clear(2,64,8,"ERR");
                print_string_at_clear(6,64,8,"ERR");
            }


            i2c_mutex.unlock();
        }
    }
}

void oled_draw_bitmap_128x64(const uint8_t *bmp) {
    for (int page = 0; page < 8; page++) {
        oled_set_pos(page, 0);
        for (int col = 0; col < 128; col++) {
            oled_data(bmp[page * 128 + col]);
        }
    }
}

// ================== MAIN ==================
int main(){
    i2c.frequency(400000);

    oled_init();
    oled_clear();

    if(!ps.init()){
        while(1);
    }
    ps.enableDefault();

    // print_string_at(3, 0, "DZIEN DOBRY!");
    oled_draw_bitmap_128x64(saturn_logo);
    ThisThread::sleep_for(1000ms);
    oled_clear();
    draw_layout();

    sensors_thread.start(sensors_task);
    display_thread.start(display_task);

    ThisThread::sleep_for(osWaitForever);
}